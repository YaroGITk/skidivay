<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Telegram WebApp Login</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg:#fff; --text:#222; --hint:#6b7280; --btn:#2aabee; --btn-text:#fff;
            --card:#f5f5f7; --radius:14px;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text);
            font: 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
        main { max-width: 760px; margin: 28px auto; padding: 24px; background: var(--card); border-radius: var(--radius); }
        h1 { margin: 0 0 10px; font-size: 22px; }
        .muted { color: var(--hint); font-size: 13px; }
        label { display:block; margin: 10px 0 6px; font-weight:600; }
        input[type="text"] { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:#fff; }
        textarea { width:100%; height:120px; padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:#fff; }
        button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 600; }
        #login { background: var(--btn); color: var(--btn-text); }
        #out { white-space: pre-wrap; margin-top: 14px; font-size: 13px; background:#fff; padding:12px; border-radius:10px; border:1px solid #eee; }
        .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
        .pill { background:#fff; padding:6px 10px; border-radius:999px; border:1px solid #eee; font-size:12px; }
    </style>
</head>
<body>
<main>
    <h1>Вход через Telegram</h1>
    <div class="row">
        <span class="pill">Пользователь: <strong id="who">неизвестно</strong></span>
        <span class="pill" id="envPill">вне Telegram</span>
    </div>

    <p class="muted">
        По умолчанию запрос идёт на <code>{origin}/api/auth/telegram/webapp</code>.
        Можно переопределить через поле ниже или query-параметр <code>?api=...</code>.
    </p>

    <label>Auth URL</label>
    <input id="apiUrl" type="text" value="http://localhost:8080/telegram" placeholder="http://localhost:8080/telegram">

    <div id="nonTgBlock" style="display:none; margin:12px 0">
        <p class="muted">
            Похоже, страница открыта <b>вне</b> Telegram. Для локальной проверки вставьте строку
            <code>initData</code> (то, что приходит из <code>Telegram.WebApp.initData</code>):
        </p>
        <textarea id="initDataText" placeholder="query-string из Telegram.WebApp.initData"></textarea>
    </div>

    <div style="margin:14px 0">
        <button id="login">Войти через Telegram</button>
    </div>

    <div id="out" aria-live="polite"></div>
</main>

<script>
    (() => {
        const tg = window.Telegram?.WebApp;
        const inTg = !!tg?.initData;
        const outEl = document.getElementById('out');
        const apiInput = document.getElementById('apiUrl');

        // ==== UI helpers ====
        const out = (msg) => outEl.textContent = msg;
        const setBusy = (b) => {
            const btn = document.getElementById('login');
            btn.disabled = b;
            btn.textContent = b ? 'Отправляю…' : 'Войти через Telegram';
        };

        // ==== Theme from Telegram ====
        function applyTheme(tp = {}) {
            const r = document.documentElement.style;
            r.setProperty('--bg', tp.bg_color || '#ffffff');
            r.setProperty('--text', tp.text_color || '#222');
            r.setProperty('--hint', tp.hint_color || '#6b7280');
            r.setProperty('--btn', tp.button_color || '#2aabee');
            r.setProperty('--btn-text', tp.button_text_color || '#ffffff');
            r.setProperty('--card', tp.secondary_bg_color || '#f5f5f7');
        }

        // ==== Init env ====
        const defaultApi = `${location.origin}/api/auth/telegram/webapp`;
        const apiFromQuery = new URLSearchParams(location.search).get('api');
        apiInput.value = apiFromQuery || defaultApi;

        document.getElementById('envPill').textContent = inTg ? 'в Telegram' : 'вне Telegram';
        document.getElementById('nonTgBlock').style.display = inTg ? 'none' : 'block';

        if (inTg) {
            try { tg.ready(); tg.expand(); } catch(_) {}
            applyTheme(tg.themeParams);
            tg.onEvent?.('themeChanged', () => applyTheme(tg.themeParams));

            const u = tg.initDataUnsafe?.user;
            if (u) document.getElementById('who').textContent =
                [u.first_name, u.last_name].filter(Boolean).join(' ') || (u.username ? '@'+u.username : 'user');
        }

        // ==== Obtain initData ====
        const getInitData = () => {
            if (inTg) return tg.initData; // Строка query-string — именно её валидирует сервер
            const t = document.getElementById('initDataText').value.trim();
            return t || null;
        };

        // ==== Login flow ====
        async function login() {
            const url = (apiInput.value || '').trim() || defaultApi;
            const initData = getInitData();

            if (!initData) {
                out('Нет initData. Открой страницу в Telegram Mini App или вставь initData вручную.');
                return;
            }

            out('Отправляю запрос…'); setBusy(true);
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        // Если твой бэк принимает "сырую" строку initData, смени на: 'Content-Type': 'text/plain'
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include',        // нужно, если сервер ставит httpOnly cookie
                    body: JSON.stringify({ initData, platform: 'webapp' }) // или body: initData для text/plain
                });

                const text = await res.text();
                let data; try { data = JSON.parse(text); } catch { data = { raw:text }; }

                if (!res.ok) {
                    out(`Ошибка ${res.status}:\n` + JSON.stringify(data, null, 2));
                    return;
                }

                if (data.accessToken) localStorage.setItem('accessToken', data.accessToken);
                if (data.refreshToken) localStorage.setItem('refreshToken', data.refreshToken);

                out('Успех:\n' + JSON.stringify(data, null, 2));
            } catch (e) {
                out('Сетевая ошибка:\n' + (e?.message || e));
            } finally {
                setBusy(false);
            }
        }

        document.getElementById('login').addEventListener('click', login);
    })();
</script>
</body>
</html>
